# Tenstorrent VSCode Toolkit - Full Development Image
# Includes code-server + TT extension + tt-metal dependencies preinstalled
# This is a larger image but includes everything needed for development

FROM codercom/code-server:latest

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV SHELL=/bin/bash
ENV TT_METAL_HOME=/home/coder/tt-metal
ENV PYTHONPATH=/home/coder/tt-metal

# Switch to root for installation
USER root

# Install system dependencies for tt-metal including Node.js for Claude CLI
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    build-essential \
    cmake \
    python3 \
    python3-pip \
    python3-venv \
    python3-dev \
    sudo \
    nodejs \
    npm \
    libhwloc-dev \
    libboost-all-dev \
    libyaml-cpp-dev \
    libgtest-dev \
    libgmock-dev \
    libtbb-dev \
    pandoc \
    software-properties-common \
    && rm -rf /var/lib/apt/lists/*

# Install Python packages commonly needed
# Note: --break-system-packages is safe in containers (PEP 668)
RUN pip3 install --no-cache-dir --break-system-packages \
    numpy \
    torch \
    transformers \
    huggingface-hub[cli] \
    matplotlib

# Install Claude Code CLI for AI-assisted development
# Authentication via ANTHROPIC_API_KEY environment variable
RUN npm install -g @anthropic-ai/claude-code

# Create directory structure
RUN mkdir -p /home/coder/.local/share/code-server/extensions \
    && mkdir -p /home/coder/tt-scratchpad \
    && mkdir -p /home/coder/models \
    && mkdir -p /home/coder/tt-metal

# Copy the extension package
COPY tt-vscode-toolkit-*.vsix /tmp/extension.vsix

# Copy entrypoint script and MOTD files
COPY scripts/docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh
COPY scripts/show-motd.sh /usr/local/bin/show-motd.sh
COPY content/motd.txt /etc/motd.txt

# Install the extension and configure VSCode settings
RUN code-server --install-extension /tmp/extension.vsix \
    && rm /tmp/extension.vsix \
    && chmod +x /usr/local/bin/docker-entrypoint.sh \
    && chmod +x /usr/local/bin/show-motd.sh

# Configure code-server with Tenstorrent theme and terminal login shell
# Terminal login shell ensures .bashrc is sourced (MOTD displays correctly)
RUN mkdir -p /home/coder/.local/share/code-server/User && \
    echo '{\n\
  "workbench.colorTheme": "Tenstorrent Dark",\n\
  "workbench.tips.enabled": false,\n\
  "telemetry.telemetryLevel": "off",\n\
  "terminal.integrated.profiles.linux": {\n\
    "bash": {\n\
      "path": "bash",\n\
      "args": ["--login"]\n\
    }\n\
  },\n\
  "terminal.integrated.defaultProfile.linux": "bash"\n\
}' > /home/coder/.local/share/code-server/User/settings.json

# Set up MOTD system
RUN cp /etc/motd.txt /home/coder/.motd \
    && echo '' >> /home/coder/.bashrc \
    && echo '# Display MOTD on terminal open' >> /home/coder/.bashrc \
    && echo 'if [ -f /usr/local/bin/show-motd.sh ]; then' >> /home/coder/.bashrc \
    && echo '    source /usr/local/bin/show-motd.sh' >> /home/coder/.bashrc \
    && echo 'fi' >> /home/coder/.bashrc

# Add coder to sudoers
RUN echo "coder ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Set proper permissions
RUN chown -R coder:coder /home/coder

# Switch back to coder user
USER coder

# Set working directory
WORKDIR /home/coder

# Expose code-server port
EXPOSE 8080

# Set default password
ENV PASSWORD=tenstorrent

# Use custom entrypoint with helpful logging
ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]
