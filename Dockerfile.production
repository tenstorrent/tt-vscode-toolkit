# Tenstorrent VSCode Toolkit - Production Image
# Includes tt-metal pre-installed and configured at ~/tt-metal
# Ready for Koyeb deployment with N300 hardware

FROM ubuntu:22.04

# Prevent interactive prompts
ENV DEBIAN_FRONTEND=noninteractive
ENV SHELL=/bin/bash

# Set up user and directories first
RUN useradd -m -s /bin/bash coder && \
    mkdir -p /home/coder/.local/share/code-server/extensions \
    /home/coder/tt-scratchpad \
    /home/coder/models \
    /home/coder/tt-metal

# Install system dependencies (tt-metal requirements)
RUN apt-get update && apt-get install -y \
    # Basic tools
    curl \
    wget \
    git \
    build-essential \
    cmake \
    sudo \
    software-properties-common \
    # Python
    python3.10 \
    python3.10-dev \
    python3-pip \
    python3.10-venv \
    # tt-metal build dependencies
    libhwloc-dev \
    libboost-all-dev \
    libyaml-cpp-dev \
    libgtest-dev \
    libgmock-dev \
    libtbb-dev \
    libnuma-dev \
    pandoc \
    # tt-smi dependencies
    pciutils \
    clang-17 \
    # Node.js for code-server
    && curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Install code-server
RUN curl -fsSL https://code-server.dev/install.sh | sh

# Switch to coder user for installations
USER coder
WORKDIR /home/coder

# Install tt-metal
RUN cd /home/coder && \
    git clone https://github.com/tenstorrent/tt-metal.git && \
    cd tt-metal && \
    git submodule update --init --recursive

# Set environment variables for tt-metal
ENV TT_METAL_HOME=/home/coder/tt-metal
ENV PYTHONPATH=/home/coder/tt-metal
ENV ARCH_NAME=wormhole_b0
ENV PATH="${TT_METAL_HOME}:${PATH}"

# Build tt-metal (as coder user)
RUN cd ${TT_METAL_HOME} && \
    bash -c "source install_dependencies.sh" && \
    ./build_metal.sh

# Set up Python environment with tt-metal packages
RUN cd ${TT_METAL_HOME} && \
    python3 -m venv python_env && \
    bash -c "source python_env/bin/activate && \
    pip install --upgrade pip && \
    pip install -e . && \
    pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu && \
    pip install transformers huggingface-hub accelerate"

# Install vLLM (for production serving)
RUN cd /home/coder && \
    git clone https://github.com/tenstorrent/vllm.git && \
    cd vllm && \
    python3 -m venv venv && \
    bash -c "source venv/bin/activate && pip install -e ."

# Copy extension and entrypoint
COPY --chown=coder:coder tt-vscode-toolkit-*.vsix /tmp/extension.vsix
COPY --chown=coder:coder scripts/docker-entrypoint.sh /home/coder/docker-entrypoint.sh

# Install extension
RUN code-server --install-extension /tmp/extension.vsix && \
    rm /tmp/extension.vsix

# Make entrypoint executable
RUN chmod +x /home/coder/docker-entrypoint.sh

# Create startup script that sources tt-metal environment
RUN echo '#!/bin/bash' > /home/coder/.tt-metal-env && \
    echo 'export TT_METAL_HOME=/home/coder/tt-metal' >> /home/coder/.tt-metal-env && \
    echo 'export PYTHONPATH=/home/coder/tt-metal' >> /home/coder/.tt-metal-env && \
    echo 'export ARCH_NAME=wormhole_b0' >> /home/coder/.tt-metal-env && \
    echo 'export PATH="${TT_METAL_HOME}:${PATH}"' >> /home/coder/.tt-metal-env && \
    echo 'source ${TT_METAL_HOME}/python_env/bin/activate' >> /home/coder/.tt-metal-env && \
    chmod +x /home/coder/.tt-metal-env

# Add to bashrc so terminal sessions have tt-metal env
RUN echo 'source /home/coder/.tt-metal-env' >> /home/coder/.bashrc

# Expose code-server port
EXPOSE 8080

# Set default password
ENV PASSWORD=tenstorrent

# Use custom entrypoint
ENTRYPOINT ["/home/coder/docker-entrypoint.sh"]
